# `XSS`攻击

## 什么是`XSS`?

`Cross-Site Scripting`（跨站脚本攻击）简称 `XSS`，是一种代码注入攻击。攻击者通过在目标网站上注入恶意脚本，使之在用户的浏览器上运行。利用这些恶意脚本，攻击者可获取用户的敏感信息如 `Cookie、SessionID` 等

`XSS` 的本质是：恶意代码未经过滤，与网站正常的代码混在一起；浏览器无法分辨哪些脚本是可信的，导致恶意脚本被执行。

## `XSS`分类

根据攻击的来源，`XSS`攻击可分为存储型、反射型和`DOM`型三种

- 存储区：恶意代码存放的位置。
- 插入点：由谁取得恶意代码，并插入到网页上。

### 存储型`XSS`

存储型`XSS`的攻击步骤：

1. 攻击者将恶意代码提交到目标网站的数据库中
2. 当用户打开浏览器时，混在其中的恶意代码也被执行
3. 进而冒充用户行为，窃取用户数据

这种攻击常用于保存数据的网站，入论坛发帖、评论等

### 反射型`XSS`

反射型 `XSS` 的攻击步骤：

1. 攻击者构造出特殊的 URL，其中包含恶意代码。
2. 用户打开带有恶意代码的 URL 时，网站服务端将恶意代码从 URL 中取出，拼接在 HTML 中返回给浏览器。
3. 用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

反射型 `XSS` 跟存储型 `XSS` 的区别是：存储型` XSS `的恶意代码存在数据库里，反射型 `XSS` 的恶意代码存在` URL `里。

反射型 `XSS` 漏洞常见于通过 `URL `传递参数的功能，如网站搜索、跳转等。

### `DOM`型`XSS`

`DOM `型 `XSS `的攻击步骤：

1. 攻击者构造出特殊的 `URL`，其中包含恶意代码。
2. 用户打开带有恶意代码的 `URL`。
3. 用户浏览器接收到响应后解析执行，前端 `JavaScript `取出` URL `中的恶意代码并执行。
4. 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

`DOM` 型` XSS` 跟前两种 `XSS` 的区别：`DOM` 型 `XSS` 攻击中，取出和执行恶意代码由浏览器端完成，属于前端 `JavaScript `自身的安全漏洞，而其他两种 `XSS` 都属于服务端的安全漏洞。

## `XSS`攻击的预防

`XSS`攻击有两大要素

1. 攻击提交恶意代码
2. 浏览器执行恶意代码

针对第一个要素：我们是否能够在用户输入的过程，过滤掉用户输入的恶意代码呢？

### 输入过滤

输入过滤并非完全可靠，我们就要通过“防止浏览器执行恶意代码”来防范 `XSS`。这部分分为两类：

- 防止 `HTML `中出现注入。
- 防止` JavaScript` 执行时，执行恶意代码。

### 预防存储型和反射型` XSS `攻击

存储型和反射型 `XSS` 都是在服务端取出恶意代码后，插入到响应 HTML 里的，攻击者刻意编写的“数据”被内嵌到“代码”中，被浏览器所执行。

预防这两种漏洞，有两种常见做法：

- 改成纯前端渲染，把代码和数据分隔开。
- 对 `HTML` 做充分转义。

### 预防` DOM` 型` XSS` 攻击

`DOM` 型 `XSS` 攻击，实际上就是网站前端 JavaScript 代码本身不够严谨，把不可信的数据当作代码执行了。

# `CSRF`攻击

## 什么是`CSRF`

`CSRF（Cross-site request forgery）`跨站请求伪造,攻击者诱导受害者进入第三方网站，在第三方网站中，向被攻击网站发送跨站请求。利用受害者在被攻击网站已经获取的注册凭证，绕过后台的用户验证，达到冒充用户对被攻击的网站执行某项操作的目的。

一个典型的`CSRF`攻击有着如下的流程：

- 用户登录`a.com`，并保留了登录凭证`（Cookie）`。
- 攻击者引诱用户访问了`b.com`。
- `b.com`向 `a.com`发送了一个请求：
- `a.com`接收到请求后，对请求进行验证，误以为是用户自己发送的请求。
- `a.com`以用户的名义执行了act=xx。
- 攻击完成，攻击者在用户不知情的情况下，冒充用户，让`a.com`执行了自己定义的操作。

## `CSRF`的特点

- 攻击一般发起在第三方网站，而不是被攻击的网站。被攻击的网站无法防止攻击发生。
- 攻击利用受害者在被攻击网站的登录凭证，冒充受害者提交操作；而不是直接窃取数据。
- 整个过程攻击者并不能获取到受害者的登录凭证，仅仅是“冒用”。
- 跨站请求可以用各种方式：图片`URL`、超链接、`CORS`、`Form`提交等等。部分请求方式可以直接嵌入在第三方论坛、文章中，难以进行追踪。

`CSRF`通常是跨域的，因为外域通常更容易被攻击者掌控。但是如果本域下有容易被利用的功能，比如可以发图和链接的论坛和评论区，攻击可以直接在本域下进行，而且这种攻击更加危险

## 防护策略

上文中讲了`CSRF`的两个特点：

- `CSRF`（通常）发生在第三方域名。
- `CSRF`攻击者不能获取到Cookie等信息，只是使用。

针对这两点，我们可以专门制定防护策略，如下：

- 阻止不明外域的访问
  - 同源检测
  - `Samesite Cookie`  Cookie 的`SameSite`属性用来限制第三方 Cookie，从而减少安全风险
- 提交时要求附加本域才能获取的信息
  - `CSRF Token`
  - 双重`Cookie`验证

